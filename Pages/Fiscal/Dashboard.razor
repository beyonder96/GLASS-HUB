@page "/fiscal"
@using GlassHub.Services.Fiscal
@using GlassHub.Models.Fiscal
@using GlassHub.Models
@using GlassHub.Services
@inject ObrigationsService ObrigationsService
@inject IExpenseService ExpenseService
@implements IDisposable

<div class="p-6 md:p-8 space-y-8 animate-fade-in pb-24">
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
            <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-500 to-purple-600">
                Escrita Fiscal
            </h1>
            <p class="text-slate-500 dark:text-zinc-400 mt-1">Gerencie suas obrigações fiscais e importe arquivos XML.</p>
        </div>
        <div class="flex gap-3">
             <a href="fiscal/obligations" class="px-5 py-2.5 bg-white dark:bg-slate-900 border border-slate-200 dark:border-white/5 rounded-2xl text-slate-600 dark:text-slate-300 font-black uppercase tracking-widest text-[10px] hover:bg-slate-50 dark:hover:bg-white/[0.04] transition-all flex items-center gap-2 shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
                Obrigações
            </a>
            <a href="fiscal/analise" class="px-5 py-2.5 bg-indigo-600 dark:bg-indigo-500 hover:bg-indigo-700 dark:hover:bg-indigo-400 text-white rounded-2xl font-black uppercase tracking-widest text-[10px] transition-all shadow-xl shadow-indigo-500/20 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                Analisar XML
            </a>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 animate-fade-in-up">
        <!-- Card 1: Pending Obligations -->
        <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-white/5 rounded-3xl p-6 shadow-xl shadow-slate-200/50 dark:shadow-none relative overflow-hidden group">
            <div class="absolute -right-4 -top-4 w-24 h-24 bg-indigo-500/5 rounded-full blur-2xl group-hover:bg-indigo-500/10 transition-colors"></div>
            <div class="relative flex flex-col h-full">
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-8 h-8 rounded-lg bg-indigo-500/10 flex items-center justify-center text-indigo-600 dark:text-indigo-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20"/><path d="m17 17-5 5-5-5"/><path d="m17 7-5-5-5 5"/></svg>
                    </div>
                    <span class="text-[10px] font-black uppercase tracking-widest text-slate-500 dark:text-zinc-500">Obrigações Pendentes</span>
                </div>
                <div class="text-4xl font-black text-slate-900 dark:text-white mb-2 leading-none">@PendingObrigationsCount</div>
                <div class="mt-auto flex items-center text-[10px] @(PendingObrigationsCount > 0 ? "text-amber-500" : "text-emerald-500") font-bold uppercase tracking-wider">
                    <span class="w-1.5 h-1.5 rounded-full @(PendingObrigationsCount > 0 ? "bg-amber-500 animate-pulse" : "bg-emerald-500") mr-2"></span>
                    @(PendingObrigationsCount > 0 ? "Atenção necessária" : "Tudo em conformidade")
                </div>
            </div>
        </div>

        <!-- Card 2: Processed XMLs -->
        <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-white/5 rounded-3xl p-6 shadow-xl shadow-slate-200/50 dark:shadow-none relative overflow-hidden group">
            <div class="absolute -right-4 -top-4 w-24 h-24 bg-emerald-500/5 rounded-full blur-2xl group-hover:bg-emerald-500/10 transition-colors"></div>
            <div class="relative flex flex-col h-full">
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-8 h-8 rounded-lg bg-emerald-500/10 flex items-center justify-center text-emerald-600 dark:text-emerald-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                    </div>
                    <span class="text-[10px] font-black uppercase tracking-widest text-slate-500 dark:text-zinc-500">XMLs Processados (Mês)</span>
                </div>
                <div class="text-4xl font-black text-slate-900 dark:text-white mb-2 leading-none">@ProcessedXmlsThisMonth</div>
                <div class="mt-auto flex items-center text-[10px] text-emerald-500 font-bold uppercase tracking-wider">
                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 mr-2"></span>
                    Base de dados atualizada
                </div>
            </div>
        </div>

        <!-- Card 3: Next Due Date -->
        <div class="bg-indigo-600 dark:bg-indigo-600 rounded-3xl p-6 text-white shadow-xl shadow-indigo-500/30 relative overflow-hidden group">
            <div class="absolute -right-4 -top-4 w-32 h-32 bg-white/10 rounded-full blur-3xl group-hover:bg-white/20 transition-all"></div>
            <div class="relative flex flex-col h-full">
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-8 h-8 rounded-lg bg-white/20 flex items-center justify-center text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                    </div>
                    <span class="text-[10px] font-black uppercase tracking-widest text-white/70">Próximo Vencimento</span>
                </div>
                <div class="text-4xl font-black mb-2 leading-none">@NextDueDate.ToString("dd/MM")</div>
                <div class="mt-auto text-[10px] font-bold uppercase tracking-widest text-white/50 truncate">
                    @NextDueName
                </div>
            </div>
        </div>
    </div>

    <!-- Upcoming Obrigações List -->
    <div class="bg-white dark:bg-zinc-900 rounded-2xl border border-slate-100 dark:border-zinc-800 shadow-sm overflow-hidden">
        <div class="p-6 border-b border-slate-100 dark:border-zinc-800 flex justify-between items-center bg-slate-50/50 dark:bg-zinc-900/50">
            <h3 class="font-bold text-slate-800 dark:text-zinc-200">Próximas Obrigações</h3>
            <a href="fiscal/obligations" class="text-xs font-bold text-indigo-600 dark:text-indigo-400 hover:underline">Ver todas</a>
        </div>
        <div class="divide-y divide-slate-100 dark:divide-zinc-800">
            @foreach (var item in Obrigations.Take(3))
            {
                <div class="p-4 hover:bg-slate-50 dark:hover:bg-zinc-800/50 transition-colors flex items-center justify-between group">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center @GetStatusColorBg(item.Status)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" class="@GetStatusColorText(item.Status)" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        </div>
                        <div>
                            <div class="font-medium text-slate-900 dark:text-white">@item.Name</div>
                            <div class="text-xs text-slate-500 dark:text-zinc-500">Vence em @item.DueDate.ToString("dd/MM/yyyy")</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                         <span class="text-sm font-bold text-slate-700 dark:text-zinc-300">@item.Value.ToString("C")</span>
                         <span class="px-2 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider @GetStatusBadge(item.Status)">
                             @TranslateStatus(item.Status)
                         </span>
                    </div>
                </div>
            }
            @if (!Obrigations.Any())
            {
                <div class="p-8 text-center text-slate-400 dark:text-zinc-500 text-sm italic">
                    Nenhuma obrigação pendente.
                </div>
            }
        </div>
    </div>
</div>

@code {
    private List<TaxObrigation> Obrigations = new();
    private int PendingObrigationsCount => Obrigations.Count(o => o.Status == ObrigationStatus.ToDo || o.Status == ObrigationStatus.Late);
    
    private int ProcessedXmlsThisMonth => ExpenseService.Invoices
        .Count(i => i.IssueDate.Month == DateTime.Now.Month && i.IssueDate.Year == DateTime.Now.Year);

    private DateTime NextDueDate;
    private string NextDueName = "";

    protected override void OnInitialized()
    {
        UpdateData();
        ObrigationsService.OnChange += UpdateData;
        ExpenseService.OnChange += UpdateData;
    }

    private void UpdateData()
    {
        Obrigations = ObrigationsService.GetObrigations();
        
        // Logical calculation for Next Due (Obligation or Invoice Installment)
        var nextObrigation = Obrigations.Where(o => o.Status != ObrigationStatus.Done).OrderBy(o => o.DueDate).FirstOrDefault();
        var nextInstallment = ExpenseService.Invoices.SelectMany(i => i.Installments)
            .Where(inst => inst.Status != PaymentStatus.PAID)
            .OrderBy(inst => inst.DueDate).FirstOrDefault();

        if (nextObrigation != null && (nextInstallment == null || nextObrigation.DueDate < nextInstallment.DueDate))
        {
            NextDueDate = nextObrigation.DueDate;
            NextDueName = nextObrigation.Name;
        }
        else if (nextInstallment != null)
        {
            NextDueDate = nextInstallment.DueDate;
            // Find parent invoice for name
            var parent = ExpenseService.Invoices.FirstOrDefault(i => i.Installments.Any(inst => inst.Id == nextInstallment.Id));
            NextDueName = $"Parcela {nextInstallment.Number} - {parent?.IssuerName ?? "Nota Fiscal"}";
        }
        else
        {
            NextDueDate = DateTime.Now;
            NextDueName = "Nenhuma pendência";
        }

        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        ObrigationsService.OnChange -= UpdateData;
        ExpenseService.OnChange -= UpdateData;
    }

    private string GetStatusColorBg(ObrigationStatus status) => status switch
    {
        ObrigationStatus.Done => "bg-emerald-100 dark:bg-emerald-500/10",
        ObrigationStatus.Late => "bg-red-100 dark:bg-red-500/10",
        ObrigationStatus.Doing => "bg-blue-100 dark:bg-blue-500/10",
        _ => "bg-slate-100 dark:bg-zinc-800"
    };

    private string GetStatusColorText(ObrigationStatus status) => status switch
    {
        ObrigationStatus.Done => "text-emerald-600 dark:text-emerald-400",
        ObrigationStatus.Late => "text-red-600 dark:text-red-400",
        ObrigationStatus.Doing => "text-blue-600 dark:text-blue-400",
        _ => "text-slate-600 dark:text-zinc-400"
    };

    private string GetStatusBadge(ObrigationStatus status) => status switch
    {
        ObrigationStatus.Done => "bg-emerald-100 text-emerald-700 dark:bg-emerald-500/10 dark:text-emerald-400",
        ObrigationStatus.Late => "bg-red-100 text-red-700 dark:bg-red-500/10 dark:text-red-400",
        ObrigationStatus.Doing => "bg-blue-100 text-blue-700 dark:bg-blue-500/10 dark:text-blue-400",
        _ => "bg-slate-100 text-slate-700 dark:bg-zinc-800 dark:text-zinc-400"
    };

    private string TranslateStatus(ObrigationStatus status) => status switch
    {
        ObrigationStatus.Done => "Concluído",
        ObrigationStatus.Late => "Atrasado",
        ObrigationStatus.Doing => "Fazendo",
        _ => "A Fazer"
    };
}
