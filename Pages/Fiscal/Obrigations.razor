@page "/fiscal/obligations"
@using GlassHub.Services.Fiscal
@using GlassHub.Models.Fiscal
@using GlassHub.Components.Fiscal
@inject ObrigationsService ObrigationsService
@implements IDisposable

<div class="p-6 md:p-8 space-y-8 animate-fade-in pb-24">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
            <a href="fiscal" class="p-2 hover:bg-slate-100 dark:hover:bg-zinc-800 rounded-full transition-colors text-slate-500 dark:text-zinc-400">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"></path><polyline points="12 19 5 12 12 5"></polyline></svg>
            </a>
            <div>
                <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Obrigações Fiscais</h1>
                <p class="text-slate-500 dark:text-zinc-400 text-sm">Acompanhe e gerencie seus impostos e tributos.</p>
            </div>
        </div>
        <button @onclick="OpenAddModal" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold text-sm transition-colors shadow-lg shadow-indigo-500/20 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            Nova Obrigação
        </button>
    </div>

    <!-- Obrador List -->
    <div class="bg-white dark:bg-zinc-900 rounded-2xl border border-slate-100 dark:border-zinc-800 shadow-sm overflow-hidden">
        <div class="divide-y divide-slate-100 dark:divide-zinc-800">
            @foreach (var item in _obrigations)
            {
                <div class="p-4 md:p-6 hover:bg-slate-50 dark:hover:bg-zinc-800/50 transition-colors flex flex-col md:flex-row md:items-center justify-between gap-4 group cursor-pointer" @onclick="() => EditObrigation(item)">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center @GetStatusColorBg(item.Status)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" class="@GetStatusColorText(item.Status)" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        </div>
                        <div>
                            <div class="font-bold text-slate-900 dark:text-white text-lg">@item.Name</div>
                            <div class="flex items-center gap-2 text-sm text-slate-500 dark:text-zinc-500">
                                <span>Vence em @item.DueDate.ToString("dd/MM/yyyy")</span>
                                <span class="w-1 h-1 rounded-full bg-slate-300 dark:bg-zinc-700"></span>
                                <span>@item.Value.ToString("C")</span>
                                @if (item.Recurrence != RecurrenceType.None)
                                {
                                     <span class="w-1 h-1 rounded-full bg-slate-300 dark:bg-zinc-700"></span>
                                     <span class="flex items-center gap-1 text-xs uppercase font-bold tracking-wider">
                                         <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>
                                         @TranslateRecurrence(item.Recurrence)
                                     </span>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center gap-3 pl-16 md:pl-0">
                         <span class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider @GetStatusBadge(item.Status)">
                             @TranslateStatus(item.Status)
                         </span>
                         
                         @if(item.Status != ObrigationStatus.Done)
                         {
                             <button @onclick="() => MarkAsDone(item.Id)" @onclick:stopPropagation="true" class="p-2 text-slate-400 hover:text-emerald-500 hover:bg-emerald-50 dark:hover:bg-emerald-500/10 rounded-lg transition-colors" title="Marcar como Concluído">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                             </button>
                         }
                    </div>
                </div>
            }
            @if (!_obrigations.Any())
            {
                <div class="p-12 text-center">
                    <div class="w-16 h-16 bg-slate-100 dark:bg-zinc-800 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" class="text-slate-400 dark:text-zinc-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    </div>
                    <h3 class="font-bold text-slate-900 dark:text-white">Nenhuma obrigação encontrada</h3>
                    <p class="text-slate-500 dark:text-zinc-500 text-sm mt-1">Crie uma nova obrigação para começar.</p>
                </div>
            }
        </div>
    </div>
    
    <ObrigationModal @bind-IsVisible="IsModalVisible" Obrigation="SelectedObrigation" OnSave="SaveObrigation" />
</div>

@code {
    private List<TaxObrigation> _obrigations = new();
    private bool IsModalVisible = false;
    private TaxObrigation? SelectedObrigation;

    protected override void OnInitialized()
    {
        _obrigations = ObrigationsService.GetObrigations();
        ObrigationsService.OnChange += StateHasChanged;
    }

    public void Dispose()
    {
        ObrigationsService.OnChange -= StateHasChanged;
    }

    private void OpenAddModal()
    {
        SelectedObrigation = null;
        IsModalVisible = true;
    }

    private void EditObrigation(TaxObrigation item)
    {
        SelectedObrigation = item;
        IsModalVisible = true;
    }

    private void SaveObrigation(TaxObrigation item)
    {
        if (string.IsNullOrEmpty(item.Id) || _obrigations.All(x => x.Id != item.Id))
        {
             ObrigationsService.AddObrigation(item);
        }
        else 
        {
             ObrigationsService.UpdateObrigation(item);
        }
        _obrigations = ObrigationsService.GetObrigations();
        IsModalVisible = false;
    }

    private void MarkAsDone(string id)
    {
        ObrigationsService.MarkAsDone(id);
        _obrigations = ObrigationsService.GetObrigations(); // Refresh list
    }

    private string GetStatusColorBg(ObrigationStatus status) => status switch
    {
        ObrigationStatus.Done => "bg-emerald-100 dark:bg-emerald-500/10",
        ObrigationStatus.Late => "bg-red-100 dark:bg-red-500/10",
        ObrigationStatus.Doing => "bg-blue-100 dark:bg-blue-500/10",
        _ => "bg-slate-100 dark:bg-zinc-800"
    };

    private string GetStatusColorText(ObrigationStatus status) => status switch
    {
        ObrigationStatus.Done => "text-emerald-600 dark:text-emerald-400",
        ObrigationStatus.Late => "text-red-600 dark:text-red-400",
        ObrigationStatus.Doing => "text-blue-600 dark:text-blue-400",
        _ => "text-slate-600 dark:text-zinc-400"
    };

    private string GetStatusBadge(ObrigationStatus status) => status switch
    {
        ObrigationStatus.Done => "bg-emerald-100 text-emerald-700 dark:bg-emerald-500/10 dark:text-emerald-400",
        ObrigationStatus.Late => "bg-red-100 text-red-700 dark:bg-red-500/10 dark:text-red-400",
        ObrigationStatus.Doing => "bg-blue-100 text-blue-700 dark:bg-blue-500/10 dark:text-blue-400",
        _ => "bg-slate-100 text-slate-700 dark:bg-zinc-800 dark:text-zinc-400"
    };
    
    private string TranslateStatus(ObrigationStatus status) => status switch
    {
        ObrigationStatus.Done => "Concluído",
        ObrigationStatus.Late => "Atrasado",
        ObrigationStatus.Doing => "Fazendo",
        _ => "A Fazer"
    };
    
    private string TranslateRecurrence(RecurrenceType type) => type switch
    {
        RecurrenceType.Daily => "Diário",
        RecurrenceType.Weekly => "Semanal",
        RecurrenceType.Fortnightly => "Quinzenal",
        RecurrenceType.Monthly => "Mensal",
        RecurrenceType.Semiannual => "Semestral",
        RecurrenceType.Yearly => "Anual",
        _ => ""
    };
}
