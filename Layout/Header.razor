@inject IJSRuntime JSRuntime
@inject NotificationService NotificationService
@inject IExpenseService ExpenseService
@inject SettingsService SettingsService
@inject CompanyService CompanyService
@inject NavigationManager Navigation
@implements IDisposable

<header class="relative flex justify-between items-center mb-12 px-6 lg:px-12 pt-10">
    <div class="relative group z-50">
        <button class="flex items-center gap-6 text-left hover:opacity-80 transition-opacity group-hover:opacity-100">
            <div class="h-14 w-14 rounded-2xl flex items-center justify-center text-white shadow-xl shadow-indigo-500/20 transform rotate-3 group-hover:rotate-0 transition-all duration-500" style="background-color: @(CompanyService.ActiveCompany?.ThemeColor ?? "#4f46e5")">
                <!-- Wallet Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>
            </div>
            <div>
                <h1 class="text-3xl font-extrabold text-slate-900 dark:text-white tracking-tight leading-none flex items-center gap-2">
                    @if (CompanyService.ActiveCompany != null)
                    {
                        <span>@CompanyService.ActiveCompany.Name.Split(' ')[0]<span class="text-indigo-600 dark:text-indigo-400">Hub</span></span>
                    }
                    else
                    {
                        <span>Glass<span class="text-indigo-600 dark:text-indigo-400">Hub</span></span>
                    }
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="opacity-30 group-hover:opacity-100 transition-opacity"><path d="m6 9 6 6 6-6"/></svg>
                </h1>
                <p class="text-sm font-medium text-slate-400 dark:text-zinc-500 mt-1">Gestão Financeira Inteligente</p>
            </div>
        </button>

        <!-- Company Selector Dropdown -->
        <div class="absolute left-0 top-full mt-4 w-80 glass-panel !bg-white/95 dark:!bg-[#050505]/95 backdrop-blur-3xl rounded-2xl border border-slate-200 dark:border-white/10 shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 transform origin-top-left p-2 z-50 max-h-[400px] overflow-y-auto custom-scrollbar">
             <div class="px-3 py-2 text-xs font-bold text-slate-400 dark:text-zinc-500 uppercase tracking-widest mb-1 flex justify-between items-center">
                 <span>Trocar Empresa</span>
                 <span class="bg-indigo-500/10 text-indigo-500 rounded px-1.5 py-0.5 text-[10px]">@CompanyService.UserCompanies.Count</span>
             </div>
             
             @{
                 var headOffices = CompanyService.UserCompanies.Where(c => c.IsHeadOffice).OrderBy(c => c.Name).ToList();
             }

             @if (!headOffices.Any())
             {
                 <div class="p-4 text-center text-slate-400 text-sm">Nenhuma empresa encontrada</div>
             }

             @foreach (var matriz in headOffices)
             {
                 var branches = CompanyService.UserCompanies.Where(c => c.ParentCompanyId == matriz.Id).OrderBy(c => c.TaxId).ToList();
                 var isActive = CompanyService.ActiveCompany?.Id == matriz.Id;
                 
                 <!-- Matriz Item -->
                 <button @onclick="() => CompanyService.SelectCompany(matriz)" class="w-full relative overflow-hidden group/item mb-1">
                    <div class="flex items-center gap-3 p-3 rounded-xl transition-all border border-transparent hover:border-slate-200 dark:hover:border-zinc-800 hover:bg-slate-50 dark:hover:bg-white/5 @(isActive ? "bg-indigo-50/50 dark:bg-indigo-900/10 border-indigo-100 dark:border-indigo-500/20" : "")">
                         <div class="h-10 w-10 rounded-lg flex items-center justify-center text-white font-bold shadow-sm relative z-10 text-sm" style="background-color: @matriz.ThemeColor">
                             @matriz.Name.Substring(0, 1).ToUpper()
                         </div>
                         <div class="text-left flex-1 min-w-0 relative z-10">
                             <div class="flex items-center gap-2">
                                 <p class="text-sm font-bold text-slate-900 dark:text-white truncate">@matriz.Name</p>
                                 @if (branches.Any())
                                 {
                                     <span class="px-1.5 py-0.5 rounded text-[9px] font-bold bg-slate-100 text-slate-500 dark:bg-zinc-800 dark:text-zinc-400">Matriz</span>
                                 }
                             </div>
                             <p class="text-[10px] text-slate-500 truncate flex items-center gap-1">
                                 @matriz.TaxId
                             </p>
                         </div>
                         @if (isActive)
                         {
                             <div class="h-2 w-2 rounded-full bg-indigo-500 shadow-[0_0_8px_rgba(99,102,241,0.6)]"></div>
                         }
                    </div>
                 </button>

                 <!-- Branches (Filiais) -->
                 @if (branches.Any())
                 {
                     <div class="ml-6 pl-4 border-l-2 border-slate-100 dark:border-zinc-800 space-y-1 mb-2">
                         @foreach (var filial in branches)
                         {
                             var isBranchActive = CompanyService.ActiveCompany?.Id == filial.Id;
                             <button @onclick="() => CompanyService.SelectCompany(filial)" class="w-full flex items-center gap-3 p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-white/5 transition-all group/branch relative @(isBranchActive ? "bg-slate-50 dark:bg-white/5" : "")">
                                 <div class="h-7 w-7 rounded flex items-center justify-center text-white text-xs font-bold opacity-70 group-hover/branch:opacity-100 transition-opacity" style="background-color: @filial.ThemeColor">
                                     @filial.Name.Substring(0, 1).ToUpper()
                                 </div>
                                 <div class="text-left flex-1 min-w-0">
                                     <div class="flex items-center gap-2">
                                         <p class="text-xs font-bold text-slate-700 dark:text-slate-300 truncate">@filial.Name</p>
                                         <span class="px-1.5 py-0.5 rounded text-[8px] font-bold bg-purple-50 text-purple-600 dark:bg-purple-900/20 dark:text-purple-300">Filial</span>
                                     </div>
                                     <p class="text-[9px] text-slate-400 truncate">@filial.TaxId</p>
                                 </div>
                                 @if (isBranchActive)
                                 {
                                     <div class="h-1.5 w-1.5 rounded-full bg-purple-500 shadow-[0_0_6px_rgba(168,85,247,0.6)]"></div>
                                 }
                             </button>
                         }
                     </div>
                 }
             }
        </div>
    </div>

    <!-- Mode Toggle -->
    <div class="absolute left-1/2 top-24 md:top-14 -translate-x-1/2 z-50">
        <div class="bg-slate-100/80 dark:bg-zinc-900/50 p-2 rounded-full flex gap-4 relative border border-slate-200 dark:border-white/10 shadow-inner backdrop-blur-2xl w-[440px] ring-1 ring-black/5 dark:ring-white/5">
            <!-- Active Pill with Glow -->
            <div class="absolute inset-y-2 w-[calc(50%-12px)] bg-white dark:bg-indigo-600 rounded-full shadow-[0_8px_25px_-5px_rgba(99,102,241,0.5)] transition-all duration-500 ease-[cubic-bezier(0.34,1.56,0.64,1)]"
                 style="left: @(IsFiscalMode ? "calc(50% + 4px)" : "8px")"></div>
            
            <button @onclick="GoToFinanceiro" class="flex-1 relative z-10 py-3.5 text-[11px] font-black uppercase tracking-widest text-center transition-all duration-500 @(!IsFiscalMode ? "text-indigo-600 dark:text-white" : "text-slate-400 dark:text-zinc-500 hover:text-slate-600 dark:hover:text-zinc-400")">
                Financeiro
            </button>
            <button @onclick="GoToFiscal" class="flex-1 relative z-10 py-3.5 text-[11px] font-black uppercase tracking-widest text-center transition-all duration-500 @(IsFiscalMode ? "text-indigo-600 dark:text-white" : "text-slate-400 dark:text-zinc-500 hover:text-slate-600 dark:hover:text-zinc-400")">
                Fiscal
            </button>
        </div>
    </div>
    
    <div class="flex items-center gap-6">
        <!-- Greetings -->
        <div class="text-right hidden md:block">
            <p class="text-sm font-medium text-slate-500 dark:text-zinc-400">Olá,</p>
            <p class="text-lg font-bold text-slate-900 dark:text-white">@SettingsService.UserName</p>
        </div>

        <!-- Notifications -->
        <div class="relative group">
            <button class="relative p-3 rounded-full border border-slate-200 dark:border-zinc-800 bg-white dark:bg-black text-slate-400 dark:text-zinc-400 hover:text-indigo-600 hover:border-indigo-200 dark:hover:text-indigo-400 dark:hover:border-indigo-500/30 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>
                
                <!-- Unread Badge -->
                @if (UnreadCount > 0)
                {
                    <span class="absolute top-2.5 right-2.5 h-2 w-2 rounded-full bg-rose-500 ring-2 ring-white dark:ring-black"></span>
                }
            </button>

            <!-- Notifications Dropdown -->
            <div class="absolute right-0 top-full mt-2 w-80 py-2 bg-white/90 dark:bg-black/90 backdrop-blur-3xl rounded-2xl border border-slate-200 dark:border-white/10 shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 transform origin-top-right ring-1 ring-black/5 dark:ring-white/5">
                <div class="px-4 py-3 border-b border-slate-100 dark:border-white/5 flex justify-between items-center">
                    <h3 class="text-sm font-semibold text-slate-800 dark:text-white">Notificações</h3>
                    @if (UnreadCount > 0)
                    {
                        <span class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-slate-100 dark:bg-zinc-900 text-slate-500 dark:text-zinc-500">@UnreadCount Novas</span>
                    }
                </div>
                
                <div class="max-h-64 overflow-y-auto">
                    @foreach (var notification in NotificationService.Notifications)
                    {
                        <a href="javascript:void(0)" class="block px-4 py-3 hover:bg-slate-50 dark:hover:bg-white/5 transition-colors @(notification.IsRead ? "opacity-60" : "opacity-100")">
                            <div class="flex gap-3">
                                <div class="mt-1 h-8 w-8 rounded-full @notification.GetBgColorClass() flex items-center justify-center @notification.GetTextColorClass() shrink-0">
                                    @((MarkupString)notification.GetIconSvg())
                                </div>
                                <div>
                                    <p class="text-xs font-medium text-slate-800 dark:text-zinc-200">@notification.Title</p>
                                    <p class="text-[10px] text-slate-500 dark:text-zinc-500 mt-0.5">@notification.Description</p>
                                    <p class="text-[10px] text-slate-400 dark:text-zinc-600 mt-1">@notification.TimeAgo</p>
                                </div>
                            </div>
                        </a>
                    }
                    
                    @if (NotificationService.Notifications.Count == 0)
                    {
                        <div class="p-4 text-center text-slate-400 dark:text-zinc-600 text-xs">
                            Nenhuma notificação
                        </div>
                    }
                </div>
                
                @if (UnreadCount > 0)
                {
                    <div class="px-4 py-2 border-t border-slate-100 dark:border-white/5 text-center">
                        <button @onclick="MarkAllAsRead" class="text-xs font-semibold text-indigo-600 dark:text-indigo-400 hover:text-indigo-700 dark:hover:text-indigo-300 w-full">
                            Marcar todas como lidas
                        </button>
                    </div>
                }
            </div>
        </div>
    </div>
</header>

@code {
    private int UnreadCount => NotificationService.Notifications.Count(n => !n.IsRead);
    private bool IsFiscalMode => Navigation.Uri.Contains("/fiscal", StringComparison.OrdinalIgnoreCase);

    private void GoToFinanceiro()
    {
        if (IsFiscalMode) Navigation.NavigateTo("/");
    }

    private void GoToFiscal()
    {
        if (!IsFiscalMode) Navigation.NavigateTo("/fiscal");
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        NotificationService.OnChange += StateHasChanged;
        Navigation.LocationChanged += OnLocationChanged;
        ExpenseService.OnChange += RefreshNotifications;
        CompanyService.OnChange += StateHasChanged;
        SettingsService.OnChange += StateHasChanged;
        
        await SettingsService.InitializeAsync();
        
        // Initial Refresh
        RefreshNotifications();
    }
    
    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
        NotificationService.OnChange -= StateHasChanged;
        ExpenseService.OnChange -= RefreshNotifications;
        SettingsService.OnChange -= StateHasChanged;
        CompanyService.OnChange -= StateHasChanged;
    }

    private void RefreshNotifications()
    {
        NotificationService.GenerateNotificationsFromInvoices(ExpenseService.Invoices);
    }

    private void MarkAllAsRead()
    {
        NotificationService.MarkAllAsRead();
    }
}
