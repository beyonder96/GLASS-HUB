@inject IExpenseService ExpenseService
@inject NotificationService NotificationService
@using System.IO

<div class="fixed bottom-10 left-1/2 -translate-x-1/2 z-50">
    
    @if(IsUploading)
    {
        <div class="absolute bottom-20 left-1/2 -translate-x-1/2 bg-white/80 dark:bg-black/80 backdrop-blur-xl border border-slate-200 dark:border-white/10 rounded-2xl p-4 w-64 shadow-2xl animate-fade-in z-50">
            <div class="flex justify-between items-center mb-2">
                <span class="text-xs font-bold text-slate-800 dark:text-white flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-indigo-500 animate-pulse"></div>
                    Importando XML
                </span>
                <span class="text-[10px] text-slate-400 dark:text-zinc-400 font-mono">@ProcessedFiles / @TotalFiles</span>
            </div>
            <p class="text-[10px] text-slate-500 dark:text-zinc-500 truncate mb-3 font-mono opacity-80">@CurrentFileName</p>
            <div class="h-1 w-full bg-slate-100 dark:bg-zinc-800 rounded-full overflow-hidden">
                <div class="h-full bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 transition-all duration-300 ease-out" style="width: @ProgressPercent%"></div>
            </div>
        </div>
    }

    <div class="flex items-center p-2 gap-1 bg-white/90 dark:bg-zinc-900/90 backdrop-blur-3xl border border-white/50 dark:border-white/10 rounded-full shadow-[0_20px_60px_-15px_rgba(0,0,0,0.3)] dark:shadow-black/80 ring-1 ring-black/5 dark:ring-white/5 transition-all duration-300 hover:scale-[1.02]">
        
        <NavLink href="" Match="NavLinkMatch.All" class="nav-pill">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
            <span class="text-xs font-bold nav-text">Painel</span>
        </NavLink>

        <NavLink href="fluxo" class="nav-pill">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>
            <span class="text-xs font-bold nav-text">Fluxo</span>
        </NavLink>

        <NavLink href="agenda" class="nav-pill">
             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
            <span class="text-xs font-bold nav-text">Agenda</span>
        </NavLink>
        
        <div class="w-px h-8 bg-slate-200 dark:bg-zinc-800 mx-1"></div>

        <div class="relative group">
             <!-- changed button to label to trigger file input directly -->
             <label for="xmlFileUpload" class="flex items-center justify-center w-12 h-12 bg-indigo-600 text-white rounded-full shadow-lg shadow-indigo-500/30 cursor-pointer hover:scale-110 transition-all mx-1">
                 @if(IsUploading)
                 {
                     <div class="animate-spin rounded-full h-5 w-5 border-2 border-white/50 border-t-white"></div>
                 }
                 else
                 {
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                 }
            </label>
        </div>
        
        <div class="w-px h-8 bg-slate-200 dark:bg-zinc-800 mx-1"></div>

        <NavLink href="notas" class="nav-pill">
             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>
             <span class="text-xs font-bold nav-text">Notas</span>
        </NavLink>
    </div>

    <AddExpenseModal @bind-IsVisible="IsManualExpenseVisible" />
    
    <!-- InputFile must be here, always present in DOM -->
    <InputFile id="xmlFileUpload" OnChange="@LoadFiles" multiple accept=".xml" class="hidden" />
</div>

<style>
    .nav-text { display: none; }
    .nav-pill { 
        display: flex; 
        align-items: center; 
        gap: 0.5rem; 
        padding: 0.75rem; 
        border-radius: 9999px; 
        color: #94a3b8; /* slate-400 */
        transition: all 0.3s;
    }
    .dark .nav-pill { color: #71717a; /* zinc-500 */ }
    
    .nav-pill:hover { background-color: rgba(241, 245, 249, 0.5); color: #475569; }
    .dark .nav-pill:hover { background-color: rgba(255, 255, 255, 0.05); color: #e4e4e7; }
    
    .nav-pill.active { 
        background-color: #f8fafc; /* slate-50 */
        color: #0f172a; /* slate-900 */
        padding-left: 1rem;
        padding-right: 1.25rem;
    }
    .dark .nav-pill.active { 
        background-color: #ffffff; 
        color: #000000; 
    }
    
    .nav-pill.active .nav-text { display: block; animation: fadeIn 0.3s; }
    
    @@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>

@code {
    private bool IsUploading = false;
    private bool IsManualExpenseVisible = false;
    
    // Upload Progress State
    private int TotalFiles = 0;
    private int ProcessedFiles = 0;
    private string CurrentFileName = "";
    private int ProgressPercent => TotalFiles == 0 ? 0 : (int)((double)ProcessedFiles / TotalFiles * 100);

    #region Upload Logic

    private async Task LoadFiles(InputFileChangeEventArgs e)
    {
        IsUploading = true;
        ProcessedFiles = 0;
        TotalFiles = 0;
        StateHasChanged(); 
        
        var newInvoices = new List<Invoice>();
        
        try
        {
            var files = e.GetMultipleFiles(500); 
            TotalFiles = files.Count;
            Console.WriteLine($"[Upload] Selected {TotalFiles} files.");
            
            foreach (var file in files)
            {
                CurrentFileName = file.Name;
                StateHasChanged(); // Update UI with current file name

                try 
                {
                    if (file.Size > 1024 * 1024 * 20) 
                    {
                        Console.WriteLine($"[Upload] File {file.Name} too large.");
                        ProcessedFiles++;
                        continue;
                    }

                    using var stream = file.OpenReadStream(maxAllowedSize: 1024 * 1024 * 20); 
                    using var ms = new MemoryStream();
                    await stream.CopyToAsync(ms);
                    ms.Position = 0;
                    
                    var invoice = await XmlParser.ParseAsync(ms, file.Name);
                    if (invoice != null)
                    {
                        newInvoices.Add(invoice);
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error: {ex.Message}");
                }
                
                ProcessedFiles++;
                // Artificial delay to make the beautiful animation visible for at least a split second per file
                // Remove in production if speed is critical, but user wants "Feedback visual"
                if (TotalFiles < 50) await Task.Delay(50); 
                else if (ProcessedFiles % 5 == 0) await Task.Delay(1); // Batch breathe

                StateHasChanged();
            }

            if (newInvoices.Any())
            {
                ExpenseService.AddInvoices(newInvoices);
                NotificationService.AddNotification(
                    "Importação Concluída", 
                    $"{newInvoices.Count} notas fiscais foram importadas com sucesso.", 
                    NotificationType.Success
                );
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Batch upload error: {ex.Message}");
            NotificationService.AddNotification(
                "Erro na Importação", 
                "Ocorreu um erro ao processar os arquivos XML.", 
                NotificationType.Error
            );
        }
        finally
        {
            // Smooth exit
            await Task.Delay(500);
            IsUploading = false;
            StateHasChanged();
        }
    }

    #endregion
}
