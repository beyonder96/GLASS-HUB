@inject IExpenseService ExpenseService

<div class="relative group cursor-pointer w-full">
    <InputFile OnChange="@LoadFiles" multiple accept=".xml" class="absolute inset-0 w-full h-full opacity-0 z-20 cursor-pointer" />
    
    <div class="flex flex-col items-center justify-center p-8 border-2 border-dashed border-slate-300 dark:border-zinc-700 rounded-3xl bg-white/50 dark:bg-zinc-900/50 hover:bg-white dark:hover:bg-zinc-900 transition-all duration-300 group-hover:border-indigo-500 group-hover:scale-[1.02] shadow-sm">
        @if (IsUploading)
        {
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mb-4"></div>
            <p class="text-sm font-medium text-slate-600 dark:text-zinc-400">Processando...</p>
        }
        else
        {
            <div class="p-4 bg-indigo-50 dark:bg-indigo-900/20 rounded-2xl text-indigo-600 dark:text-indigo-400 mb-4 transition-transform group-hover:rotate-6">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
            </div>
            <h3 class="text-lg font-bold text-slate-800 dark:text-white">Importar XML</h3>
            <p class="text-sm text-center text-slate-500 max-w-[200px] leading-relaxed mt-2">Arraste seus arquivos NF-e aqui ou clique para selecionar</p>
        }
    </div>
</div>

@code {
    private bool IsUploading = false;

    private async Task LoadFiles(InputFileChangeEventArgs e)
    {
        IsUploading = true;
        try
        {
            var files = e.GetMultipleFiles(100); 
            foreach (var file in files)
            {
                using var stream = file.OpenReadStream(maxAllowedSize: 1024 * 1024 * 5); // 5MB
                using var ms = new MemoryStream();
                await stream.CopyToAsync(ms);
                ms.Position = 0;
                
                var invoice = await XmlParser.ParseAsync(ms, file.Name);
                if (invoice != null)
                {
                    ExpenseService.AddInvoice(invoice);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Upload error: {ex.Message}");
        }
        finally
        {
            IsUploading = false;
        }
    }
}
