@using GlassHub.Models
@using GlassHub.Services
@inject IExpenseService ExpenseService

@if (IsVisible)
{
    <div class="fixed inset-0 z-[100] flex items-center justify-center p-6 animate-fade-in">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @onclick="Close"></div>
        
        <div class="relative w-full max-w-md bg-white dark:bg-[#09090b] border border-slate-200 dark:border-white/10 rounded-[32px] shadow-2xl shadow-indigo-500/10 overflow-hidden animate-pop-up">
            
            <!-- Header -->
            <div class="p-8 pb-0 flex justify-between items-center">
                <h3 class="text-2xl font-bold text-slate-800 dark:text-white tracking-tight">Novo Lançamento</h3>
                <button @onclick="Close" class="p-2 text-slate-400 dark:text-zinc-500 hover:text-indigo-600 dark:hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>

            <EditForm Model="@NewExpense" OnValidSubmit="HandleSubmit" class="p-8 space-y-6">
                <DataAnnotationsValidator />

                <!-- Description -->
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate-400 dark:text-zinc-500 uppercase tracking-widest ml-1">Descrição</label>
                    <div class="relative group">
                         <div class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 dark:text-zinc-600 group-focus-within:text-indigo-500 transition-colors">
                             <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                         </div>
                        <InputText @bind-Value="NewExpense.Description" placeholder="Ex: Aluguel, Simples Nacional..." class="w-full pl-12 pr-4 py-4 rounded-xl bg-slate-50 dark:bg-[#0f0f12] border border-slate-200 dark:border-zinc-800 focus:border-indigo-500/50 focus:bg-white dark:focus:bg-[#151518] focus:outline-none focus:ring-1 focus:ring-indigo-500/50 text-slate-800 dark:text-zinc-200 placeholder:text-slate-400 dark:placeholder:text-zinc-600 transition-all text-sm" />
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <!-- Value -->
                    <div class="space-y-2">
                         <label class="text-[10px] font-bold text-slate-400 dark:text-zinc-500 uppercase tracking-widest ml-1">Valor (R$)</label>
                         <div class="relative group">
                             <div class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 dark:text-zinc-600 group-focus-within:text-emerald-500 transition-colors font-bold text-sm">$</div>
                             <InputNumber @bind-Value="NewExpense.Value" class="w-full pl-10 pr-4 py-4 rounded-xl bg-slate-50 dark:bg-[#0f0f12] border border-slate-200 dark:border-zinc-800 focus:border-indigo-500/50 focus:bg-white dark:focus:bg-[#151518] focus:outline-none focus:ring-1 focus:ring-indigo-500/50 text-slate-800 dark:text-zinc-200 transition-all text-sm" />
                         </div>
                    </div>

                    <!-- Date -->
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold text-slate-400 dark:text-zinc-500 uppercase tracking-widest ml-1">Vencimento</label>
                        <div class="relative group">
                            <div class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 dark:text-zinc-600 group-focus-within:text-indigo-500 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                            </div>
                            <InputDate @bind-Value="NewExpense.DueDate" class="w-full pl-12 pr-4 py-4 rounded-xl bg-slate-50 dark:bg-[#0f0f12] border border-slate-200 dark:border-zinc-800 focus:border-indigo-500/50 focus:bg-white dark:focus:bg-[#151518] focus:outline-none focus:ring-1 focus:ring-indigo-500/50 text-slate-800 dark:text-zinc-200 transition-all text-sm dark:[color-scheme:dark]" />
                        </div>
                    </div>
                </div>

                <!-- Category -->
                <div class="space-y-2">
                    <div class="flex justify-between items-center ml-1">
                        <label class="text-[10px] font-bold text-slate-400 dark:text-zinc-500 uppercase tracking-widest">Categoria</label>
                         <button type="button" @onclick="ToggleCategoryMode" class="text-[10px] font-bold text-indigo-600 dark:text-indigo-500 hover:text-indigo-700 dark:hover:text-indigo-400 flex items-center gap-1 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
                            @(IsCustomCategory ? "Selecionar Lista" : "Digitar Manual")
                        </button>
                    </div>
                    
                    <div class="relative group">
                         <div class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 dark:text-zinc-600 group-focus-within:text-indigo-500 transition-colors">
                             <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
                         </div>
                        @if (IsCustomCategory)
                        {
                            <InputText @bind-Value="CustomCategory" @onblur="ApplyCustomCategory" placeholder="Descreva a categoria..." class="w-full pl-12 pr-4 py-4 rounded-xl bg-slate-50 dark:bg-[#0f0f12] border border-slate-200 dark:border-zinc-800 focus:border-indigo-500/50 focus:bg-white dark:focus:bg-[#151518] focus:outline-none focus:ring-1 focus:ring-indigo-500/50 text-slate-800 dark:text-zinc-200 transition-all text-sm" />
                        }
                        else
                        {
                            <InputSelect @bind-Value="NewExpense.Category" class="w-full pl-12 pr-4 py-4 rounded-xl bg-slate-50 dark:bg-[#0f0f12] border border-slate-200 dark:border-zinc-800 focus:border-indigo-500/50 focus:bg-white dark:focus:bg-[#151518] focus:outline-none focus:ring-1 focus:ring-indigo-500/50 text-slate-800 dark:text-zinc-200 transition-all text-sm appearance-none cursor-pointer">
                                @foreach (var cat in PredefinedCategories)
                                {
                                    <option value="@cat.Value">@cat.Label</option>
                                }
                            </InputSelect>
                            
                             <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400 dark:text-zinc-600">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                             </div>
                        }
                    </div>
                </div>

                <div class="pt-2">
                    <button type="submit" class="w-full py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold text-sm shadow-[0_0_20px_-5px_rgba(79,70,229,0.3)] hover:shadow-[0_0_25px_-5px_rgba(79,70,229,0.5)] transition-all active:scale-[0.98]">
                        Adicionar ao Fluxo
                    </button>
                </div>

            </EditForm>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public DateTime? InitialDate { get; set; }

    private ManualExpense NewExpense { get; set; } = new() { DueDate = DateTime.Today };
    private bool IsCustomCategory = false;
    private string CustomCategory { get; set; } = "";

    protected override void OnParametersSet()
    {
        if (IsVisible && InitialDate.HasValue && NewExpense.DueDate == DateTime.Today)
        {
           // Only override if it looks like default
           NewExpense.DueDate = InitialDate.Value;
        }
    }

    private List<(string Value, string Label)> PredefinedCategories = new()
    {
        ("OUTROS", "Outros"),
        ("IMPOSTO", "Imposto"),
        ("ALUGUEL", "Aluguel"),
        ("SALARIO", "Salário"),
        ("SERVICO", "Serviço"),
        ("FORNECEDOR", "Fornecedor"),
        ("MANUTENCAO", "Manutenção")
    };

    private void ToggleCategoryMode()
    {
        IsCustomCategory = !IsCustomCategory;
        if (!IsCustomCategory) NewExpense.Category = "OUTROS";
        else CustomCategory = "";
    }

    private void ApplyCustomCategory()
    {
        if (!string.IsNullOrWhiteSpace(CustomCategory))
        {
            NewExpense.Category = CustomCategory.ToUpper();
        }
    }

    private void Close()
    {
        IsVisible = false;
        IsVisibleChanged.InvokeAsync(false);
    }

    private void HandleSubmit()
    {
        if (IsCustomCategory && !string.IsNullOrWhiteSpace(CustomCategory))
        {
            NewExpense.Category = CustomCategory.ToUpper();
        }

        // Create a copy to add
        var toAdd = new ManualExpense
        {
             Description = NewExpense.Description,
             Value = NewExpense.Value,
             DueDate = NewExpense.DueDate,
             Category = NewExpense.Category,
             Status = PaymentStatus.PENDING
        };

        ExpenseService.AddManualExpense(toAdd);
        
        // Reset
        NewExpense = new() { DueDate = DateTime.Today, Category = "OUTROS" };
        IsCustomCategory = false;
        CustomCategory = "";
        
        Close();
    }
}
